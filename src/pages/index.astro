---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import BlogPostPreview from "../components/BlogPostPreview.astro";

let title = "Blog";

// Use import.meta.glob to fetch all post with associated frontmatter
const posts = import.meta.glob("./posts/*.md", { eager: true });
const unsortedPosts = Object.values(posts);
const sortedPosts = unsortedPosts
  .filter((post) => post.frontmatter.published === true)
  .sort(function (a, b) {
    return new Date(b.frontmatter.pubDate).valueOf() - new Date(a.frontmatter.pubDate).valueOf();
  });
// slice first index and return modified original array
const finalSortedPosts = sortedPosts.length > 1 ? sortedPosts.slice(1) : [];
const mostRecentPost = sortedPosts.length > 0 ? sortedPosts[0] : null;
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <BaseHead title={title} />
  </head>

  <body class="bg-[#f7f7f7] dark:bg-gray-900 transition-colors duration-300">
    <Header />

    <main class="max-w-4xl mx-auto px-6 py-16">
      <!-- Hero Section -->
      <section class="text-center mb-20">
        <h1 class="text-6xl md:text-7xl font-bold font-heading text-gray-900 dark:text-gray-100 tracking-tight leading-[1.1] mb-4">
          Brian Via's Blog
        </h1>
        <p class="text-2xl md:text-3xl text-secondary-700 dark:text-gray-400 italic font-serif mt-8">
          "I don't have talent, so I just get up earlier."
        </p>
        <p class="text-lg text-gray-600 dark:text-gray-500 mt-2">
          -Henry Rollins
        </p>
      </section>

      <!-- Featured Post -->
      {mostRecentPost && (
        <section id="most-recent-post" class="mb-24">
          <h2 class="text-4xl font-bold font-heading text-gray-900 dark:text-gray-100 mb-8 tracking-tight">
            Latest Post
          </h2>
          <BlogPostPreview
            title={mostRecentPost.frontmatter.title}
            description={mostRecentPost.frontmatter.description || ""}
            pubDate={mostRecentPost.frontmatter.pubDate}
            url={`/posts/${mostRecentPost.frontmatter.slug}`}
            mostRecentPost={true}
            tags={mostRecentPost.frontmatter.tags || []}
          />
        </section>
      )}

      <!-- All Posts Timeline -->
      <section aria-label="Blog post list">
        <h2 class="text-4xl font-bold font-heading text-gray-900 dark:text-gray-100 mb-8 tracking-tight">
          All Posts
        </h2>
        <div class="relative">
          <!-- Timeline vertical line -->
          <div class="absolute left-0 top-0 bottom-0 w-0.5 bg-gray-300 dark:bg-gray-700"></div>

          <div class="space-y-6 pl-8">
            {finalSortedPosts.map((post) => (
              <div class="relative">
                <!-- Timeline dot -->
                <div class="absolute -left-[34px] top-3 w-2 h-2 bg-gray-400 dark:bg-gray-600 rounded-full"></div>

                <a
                  href={`/posts/${post.frontmatter.slug}`}
                  class="block bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-700 rounded-sm p-6 transition-all hover:border-gray-400 dark:hover:border-gray-600 group"
                >
                  <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                      <h3 class="text-xl font-bold font-heading text-gray-900 dark:text-gray-100 mb-2 tracking-tight group-hover:text-gray-700 dark:group-hover:text-gray-300 transition-colors">
                        {post.frontmatter.title}
                      </h3>
                      <p class="text-secondary-700 dark:text-gray-400 text-base leading-relaxed line-clamp-1">
                        {post.frontmatter.description || ""}
                      </p>
                    </div>
                    <time class="text-sm text-gray-500 dark:text-gray-500 whitespace-nowrap mt-1">
                      {new Date(post.frontmatter.pubDate).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                      })}
                    </time>
                  </div>
                </a>
              </div>
            ))}
          </div>
        </div>
      </section>
    </main>

    <Footer />
  </body>
</html>
